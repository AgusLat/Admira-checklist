<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap"
      rel="stylesheet"
    />
    <title>Checklist</title>
    <link rel="stylesheet" href="styles/style.css" />
  </head>
  <body>
    <div class="slides" id="slides"></div>

    <div id="issueModal">
      <div id="issueContent">
        <h3>⚠ Reportar incidencia</h3>
        <p id="issueStep"></p>
        <textarea
          id="issueDesc"
          placeholder="Describe el problema..."
          rows="4"
        ></textarea>
        <div style="text-align: center">
          <button id="cancelIssueBtn">Cancelar</button>
          <button id="sendIssueBtn">Enviar</button>
        </div>
      </div>
    </div>

    <script type="module">
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        query,
        where,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
      import { firebaseConfig } from "../firebase/firebaseConfig.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
      import {
        renderSlides,
        currentSlideIndex,
        nextSlide,
        slides,
      } from "./js/slides-control.js";
      import {
        reportIssue,
        processPendingIncidencia,
      } from "./js/incidencias.js";
      import { openIssueModal, closeIssueModal } from "./js/modal.js";
      import {
        slidesSantaRosa,
        slidesPlanetaNave,
        slidesPlanetaTerminator,
        slidesStore,
      } from "./slides/slides.js";

      // INICIAR FIREBASE
      if (!window.firebaseApp) {
        window.firebaseApp = initializeApp(firebaseConfig);
        window.db = getFirestore(window.firebaseApp);
        window.firebaseAddDoc = addDoc;
        window.firebaseCollection = collection;
        window.firebaseGetDocs = getDocs;
        window.firebaseQuery = query;
        window.firebaseWhere = where;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseAuth = getAuth(window.firebaseApp);
      }

      // PARAMS
      const oficina = new URLSearchParams(window.location.search).get(
        "oficina"
      );
      const seccion = new URLSearchParams(window.location.search).get(
        "seccion"
      );

      // VARIABLES
      const sitios = {
        santarosa: slidesSantaRosa,
        planetanave: slidesPlanetaNave,
        planetaterminator: slidesPlanetaTerminator,
        store: slidesStore,
      };

      // ELEMENTOS
      const slidesArray = Object.values(sitios[oficina][seccion]);
      const container = document.getElementById("slides");
      const cancelIssueBtn = document.getElementById("cancelIssueBtn");
      const sendIssueBtn = document.getElementById("sendIssueBtn");

      // EVENTOS
      cancelIssueBtn.addEventListener("click", () => {
        document.getElementById("issueModal").style.display = "none";
        document.getElementById("issueDesc").value = "";
        document.getElementById("issueFile").value = "";
      });

      sendIssueBtn.addEventListener("click", async () => {
        const issueDesc = document.getElementById("issueDesc").value.trim();

        if (!issueDesc) {
          alert("Por favor, describe la incidencia antes de enviar.");
          return;
        }

        const issue = {
          oficina: oficina,
          seccion: seccion,
          incidencia: issueDesc,
          paso: currentSlideIndex,
          pasoDesc: slides[currentSlideIndex].desc,
        };

        await reportIssue(issue);
        // await processPendingIncidencia();
        await nextSlide();
        closeIssueModal();
      });

      // RENDERIZA LAS SLIDES (pasamos la sección actual)
      renderSlides(container, slidesArray, seccion);
    </script>
  </body>
</html>
