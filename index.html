<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Acceso</title>
    <link rel="stylesheet" href="styles/index.css" />
    <!-- <base href="https://yokup.com/visitas/" /> -->

    <!--EmailJS -->
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"
    ></script>
    <script type="text/javascript">
      (function () {
        emailjs.init({
          publicKey: "AOsFjcFh572HFsomg",
        });
      })();
    </script>
  </head>

  <body>
    <main>
      <div class="contenedor" id="login-container">
        <img id="logo-admira" src="/img/assets/admira-logo.png" />
        <h1>Ir a la plataforma</h1>
        <button id="login-button">
          <img
            src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"
            alt="Google"
            class="google-icon"
          />
          <span>Iniciar sesión con Google</span>
        </button>
      </div>
    </main>

    <script type="module">
      import { startGlobalFirebase } from "./firebase/firebaseConfig.js";
      import {
        loginUser,
        isAuthorizedUser,
      } from "./js/auth/loginController.js";
      import { auth } from "./firebase/firebaseConfig.js";
      import {
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

      // Hacer disponible globalmente para otros módulos
      startGlobalFirebase();

      // Importar la función de crear checklist
      const { createChecklistDocument } = await import(
        "./js/checklist-manager.js"
      );

      // Evento de login
      const loginButton = document.getElementById("login-button");
      loginButton.addEventListener("click", loginUser);

      // Manejo de sesión activa
      onAuthStateChanged(auth, async (user) => {
        if (!user) return;

        const autorizado = await isAuthorizedUser(user.email);
        if (autorizado) {
          const oficina =
            new URLSearchParams(window.location.search).get("oficina") ||
            localStorage.getItem("oficinaParam") ||
            "store";

          // *** CREAR EL DOCUMENTO DE CHECKLIST ***
          // Si ya hay sesión, verificar si hay un checklist activo
          const checklistId = localStorage.getItem("currentChecklistId");
          if (!checklistId) {
            // No hay checklist activo, crear uno nuevo
            try {
              await createChecklistDocument(oficina, user.email);
              console.log("✅ Checklist creado para sesión existente");
            } catch (error) {
              console.error("⚠️ Error al crear checklist:", error);
            }
          }

          window.location.href = `nav-menu.html?oficina=${encodeURIComponent(
            oficina
          )}`;
        } else {
          signOut(auth);
        }
      });
    </script>
  </body>
</html>
