<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Menú principal</title>
    <link rel="stylesheet" href="styles/nav-menu.css" />
  </head>

  <body>
    <main>
      <div class="contenido">
        <h1>CHECKLIST ADMIRA</h1>
        <nav class="navMenu" id="menu"></nav>
        <button id="abortChecklistBtn" class="abort-btn" style="display: none;">
         ABORTAR CHECKLIST
        </button>
         <a class="logoutBtn" href="#logout">CERRAR SESIÓN</a>
      </div>
    </main>

    <script type="module">
      import { firebaseConfig } from "./firebase/firebaseConfig.js";
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
      import {
        slidesSantaRosa,
        slidesStore,
        slidesPlanetaTerminator,
        slidesPlanetaNave,
      } from "./slides/slides.js";
      import { abortChecklist } from "./firebase/checklist-manager.js";

      // --- 1. Configuración Firebase (misma que index) ---

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      // --- 2. Verificar sesión ---
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = "index.html";
          return;
        }

        // --- 3. Construir menú según parámetro ---
        const oficina =
          new URLSearchParams(window.location.search).get("oficina") ||
          "general";
        const menu = document.getElementById("menu");
        let opciones = [];

        switch (oficina) {
          case "santarosa":
            opciones = Object.keys(slidesSantaRosa).map((titulo) => ({
              seccion: titulo.toLocaleUpperCase(),
              href: `slides.html?oficina=${oficina}&seccion=${titulo}`,
            }));
            break;
          case "store":
            opciones = Object.keys(slidesStore).map((titulo) => ({
              seccion: titulo.toLocaleUpperCase(),
              href: `slides.html?oficina=${oficina}&seccion=${titulo}`,
            }));
            break;
          case "planetaterminator":
            opciones = Object.keys(slidesPlanetaTerminator).map((titulo) => ({
              seccion: titulo.toLocaleUpperCase(),
              href: `slides.html?oficina=${oficina}&seccion=${titulo}`,
            }));
            break;
          case "planetanave":
            opciones = Object.keys(slidesPlanetaNave).map((titulo) => ({
              seccion: titulo.toLocaleUpperCase(),
              href: `slides.html?oficina=${oficina}&seccion=${titulo}`,
            }));
            break;
          default:
            opciones = [{ seccion: "OFICINA NO IDENTIFICADA", href: "" }];
            break;
        }

        // Render del menú
        menu.innerHTML = `
      <ul>
        ${opciones
          .map((opt) => `<li><a href="${opt.href}">${opt.seccion}</a></li>`)
          .join("")}
      </ul>
     
    `;

        // --- 4. Logout ---
        document
          .querySelector('a[href="#logout"]')
          .addEventListener("click", async () => {
            await signOut(auth);
            localStorage.clear();
            window.location.href = `index.html?oficina=${oficina}`;
          });
      });

        // Obtener el botón
        const abortBtn = document.getElementById("abortChecklistBtn");

        // Mostrar el botón solo si hay un checklist activo
        const checklistId = localStorage.getItem("currentChecklistId");
        if (checklistId) {
        abortBtn.style.display = "block";
        }

      // Evento para abortar checklist
      abortBtn.addEventListener("click", async () => {
        const confirmar = confirm(
        "⚠️ ¿Estás seguro de que quieres abortar el checklist?\n\n" +
        "El checklist se marcará como INCOMPLETO y se cerrará.\n" +
        "Esta acción no se puede deshacer."
      );

      if (confirmar) {
        try {
          await abortChecklist();
          alert("✅ Checklist abortado correctamente");
          // Recargar la página para actualizar la UI
          location.reload();
        } catch (error) {
          console.error("❌ Error al abortar checklist:", error);
          alert("❌ Error al abortar el checklist. Revisa la consola.");
        }
      }
    });

    </script>
  </body>
</html>
