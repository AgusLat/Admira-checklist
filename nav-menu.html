<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap"
      rel="stylesheet"
    />

    <title>Menú principal</title>
    <link rel="stylesheet" href="styles/nav-menu.css" />

    <!-- EmailJS -->
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"
    ></script>
    <script type="text/javascript">
      (function () {
        emailjs.init({
          publicKey: "AOsFjcFh572HFsomg",
        });
      })();
    </script>
  </head>

  <body>
    <main>
      <div class="contenido">
        <h1>
          <img class="ready-logo" src="./img/assets/admira-text.png" /> READY!
        </h1>
        <span id="loader" class="loader"></span>
        <nav class="navMenu" id="menu"></nav>

        <!-- Indicador de progreso -->
        <div
          id="progressIndicator"
          style="display: none"
          class="progressIndicator"
        >
          <ul id="progressText"></ul>
        </div>

        <div class="btnContainer">
          <button
            id="completeChecklistBtn"
            class="complete-btn disabled"
            disabled
          >
            READY!
          </button>
          <button id="abortChecklistBtn" class="abort-btn disabled" disabled>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="icon icon-tabler icons-tabler-outline icon-tabler-trash-x"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M4 7h16" />
              <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
              <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
              <path d="M10 12l4 4m0 -4l-4 4" /></svg
            >Borrar checklist
          </button>

          <button class="logoutBtn" id="logoutBtn">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="icon icon-tabler icons-tabler-outline icon-tabler-logout-2"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path
                d="M10 8v-2a2 2 0 0 1 2 -2h7a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-7a2 2 0 0 1 -2 -2v-2"
              />
              <path d="M15 12h-12l3 -3" />
              <path d="M6 15l-3 -3" /></svg
            >Cerrar sesión
          </button>
        </div>
      </div>
    </main>

    <script type="module">
      import { startGlobalFirebase, auth } from "./firebase/firebaseConfig.js";
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
      import {
        getOficina,
        ensureChecklist,
        renderNavMenu,
        renderProgressStats,
      } from "./js/nav-menu-controller.js";
      import { logoutUser } from "./js/auth/loginController.js";
      import {
        abortChecklist,
        completeChecklist,
        isChecklistComplete,
        cleanupOldChecklists,
      } from "./js/checklist-manager.js";

      // Iniciar Firebase
      startGlobalFirebase();

      // Elementos del DOM
      const navMenu = document.getElementById("menu");
      const logoutBtn = document.getElementById("logoutBtn");
      const abortBtn = document.getElementById("abortChecklistBtn");
      const completeBtn = document.getElementById("completeChecklistBtn");
      const progressIndicator = document.getElementById("progressIndicator");
      const progressText = document.getElementById("progressText");
      const loader = document.getElementById("loader");

      // Eventos
      logoutBtn.addEventListener("click", logoutUser);
      abortBtn.addEventListener("click", abortChecklist);
      completeBtn.addEventListener("click", completeChecklist);

      // Variables
      const oficina = getOficina();

      // Renderizar menu al cargar la página
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "index.html";
          return;
        }

        // Limpieza de checklists antiguos
        await cleanupOldChecklists();
        // Verificar estado del checklist: cerrado o crear uno nuevo
        await ensureChecklist(user, oficina);
        const checklistClosed = localStorage.getItem("checklistClosed");
        const checklistId = localStorage.getItem("currentChecklistId");
        if (checklistClosed === "true") {
          loader.style.display = "none";
          abortBtn.classList.add("disabled");
          completeBtn.classList.add("disabled");

          menu.innerHTML = `<div class="closed-checklist"><img src="./img/assets/checklist-complete.png"><h2>¡Checklist finalizado!</h2> <p>Cerrar sesión para completar </p></div>`;
          return;
        }

        //Renderizar menú de navegación
        if (checklistId && checklistClosed === null) {
          const { isComplete, stats } = await isChecklistComplete();
          loader.style.display = "none";
          abortBtn.disabled = false;
          abortBtn.classList.remove("disabled");
          renderNavMenu(oficina, navMenu, stats?.porSeccion);
          renderProgressStats(stats);

          if (isComplete) {
            completeBtn.disabled = false;
            completeBtn.classList.remove("disabled");
          } else {
            completeBtn.classList.add("disabled");
          }
        }
      });
    </script>
  </body>
</html>
